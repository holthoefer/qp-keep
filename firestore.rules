
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is an admin
    function isAdmin() {
      // Check the user's role from their profile in the 'users' collection
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users can only read and write their own profile.
    // Admins can read/write any profile.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || isAdmin();
      allow create: if request.auth.uid == userId;
    }

    // Notes:
    // - Users can create notes.
    // - Users can read, update, and delete their own notes.
    // - Admins can read all notes.
    match /notes/{noteId} {
      allow create: if request.auth.uid != null;
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow update, delete: if request.auth.uid == resource.data.userId;
    }

    // Control Plans (Legacy, Simple)
    // - Authenticated users can create/read plans.
    // - Admins can update/delete any plan.
    match /controlplan/{planId} {
        allow read, create: if request.auth.uid != null;
        allow update, delete: if isAdmin();
    }
    
    // Lenkungsplan (Legacy, Simple)
    // - Authenticated users can create/read plans.
    // - Admins can update/delete any plan.
    match /lenkungsplan/{planId} {
        allow read, create: if request.auth.uid != null;
        allow update, delete: if isAdmin();
    }

    // Control Plans (New, Advanced)
    // - Authenticated users can create/read plans.
    // - The user who last changed it or an admin can update/delete.
    match /control-plans/{planId} {
        allow read, create: if request.auth.uid != null;
        allow update, delete: if request.auth.uid == resource.data.lastChangedBy || isAdmin();
    }

    // Workstations
    // - Authenticated users can read all workstations.
    // - Admins can create, update, and delete workstations.
    match /workstations/{wsId} {
      allow read: if request.auth.uid != null;
      allow create, update, delete: if isAdmin();
    }
  }
}

    