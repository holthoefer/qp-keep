rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Helper function to check if a user's account is active
    function isActive() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.status == 'active';
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
        return request.auth != null;
    }

    // Users can read their own profile, admins can read any profile
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId; // Users can update their own profile initially
      allow update: if isAdmin(); // Admins can update any profile (e.g., change role/status)
      allow create: if request.auth.uid == userId; // A user can create their own profile document
    }

    // Notes: Users can manage their own notes, admins can read all notes.
    match /notes/{noteId} {
      allow read: if request.auth.uid == resource.data.userId || isAdmin();
      allow create: if request.auth.uid == request.resource.data.userId && isActive();
      allow delete: if request.auth.uid == resource.data.userId;
    }
    
    // Control Plans (Advanced)
    match /control-plans/{planId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin() && isActive();
    }
    
    // Lenkungsplan (Legacy Simple Control Plan)
    match /lenkungsplan/{planId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin() && isActive();
    }
    
    // Workstations
    match /workstations/{wsId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin() && isActive();
    }

    // Auftraege
    match /auftraege/{auftragId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isAdmin() && isActive();
    }

    // DNA and Samples
    match /dna/{dnaId} {
        allow read, write: if isAuthenticated() && isActive();
    }

    match /samples/{sampleId} {
        allow read, write: if isAuthenticated() && isActive();
        allow delete: if isAdmin() && isActive();
    }
    
    // Incidents
    match /incidents/{incidentId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isActive();
        allow update, delete: if isAdmin() && isActive();
    }

  }
}
